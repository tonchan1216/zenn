---
title: "Mavenã§ã¯ã˜ã‚ã‚‹Gatlingç”Ÿæ´»"
emoji: "ğŸ”«"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Gatling", "Maven", "performance"]
published: false
---

# ã¯ã˜ã‚ã«

è² è·ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦æœ‰åãªGatlingã«ã¤ã„ã¦ã€ä»Šå›ã¯MavençµŒç”±ã§å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚„ã€å®Ÿè¡Œå¯èƒ½ãªJarãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆæ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

# å‹•ä½œç’°å¢ƒ

## å„ç¨®ãƒãƒ¼ã‚¸ãƒ§ãƒ³

- Windows (WSL2 Ubuntu 18.04.6 LTS)
- openjdk 11.0.13
- Apache Maven 3.6.0

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
â”œâ”€â”€ pom.xml (mavenã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«)
â”œâ”€â”€ results (ãƒ†ã‚¹ãƒˆçµæœã®æ ¼ç´å…ˆ)
â”œâ”€â”€ src (Gatlingã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æœ¬ä½“)
â”‚Â Â  â””â”€â”€ main
â”‚Â Â      â”œâ”€â”€ resources
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ gatling.conf
â”‚Â Â      â”‚Â Â  â””â”€â”€ logback-test.xml
â”‚Â Â      â””â”€â”€ scala
â”‚Â Â          â””â”€â”€ simulation
â”‚Â Â           Â Â  â””â”€â”€ PeakModel.scala (ãƒ¡ã‚¤ãƒ³ã®Scalaãƒ•ã‚¡ã‚¤ãƒ«)
â””â”€â”€ target (ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸã‚½ãƒ¼ã‚¹ã®æ ¼ç´å…ˆ)
```

# pom.xml

## åŸºæœ¬è¨­å®š

packagingã¯jarã‚’æŒ‡å®š

dependencyã«ã¯[å…¬å¼ã‚µã‚¤ãƒˆ](https://gatling.io/docs/gatling/reference/current/extensions/maven_plugin/)ã‚’å‚è€ƒã«ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹

- gatling-charts-highcharts

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">

    <modelVersion>4.0.0</modelVersion>

    <groupId>org.xxxx</groupId>
    <artifactId>gatling</artifactId>
    <packaging>jar</packaging>
    <version>1.0.0</version>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>

        <gatling.version>3.5.1</gatling.version>
        <gatling-maven-plugin.version>3.1.2</gatling-maven-plugin.version>
        <maven-jar-plugin.version>3.2.0</maven-jar-plugin.version>
        <maven-shade-plugin.version>3.2.4</maven-shade-plugin.version>
        <scala-maven-plugin.version>4.5.3</scala-maven-plugin.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>io.gatling.highcharts</groupId>
            <artifactId>gatling-charts-highcharts</artifactId>
            <version>${gatling.version}</version>
        </dependency>
    </dependencies>

    <build>
      ~å¾Œè¿°~
    </build>

</project>
```

## Pluginã®è¨­å®š

å…¬å¼ãƒšãƒ¼ã‚¸ã«ã¯[ã“ã¡ã‚‰ã®Github](https://github.com/gatling/gatling-maven-plugin-demo-scala)ã‚’å‚è€ƒã«ã—ã¦ã¨æ›¸ã„ã¦ã‚ã‚‹ã®ã§ã€ã¾ãšä»¥ä¸‹ã®3ã¤ã‚’è¿½åŠ ã™ã‚‹ã€‚

- maven-jar-plugin
- scala-maven-plugin
- gatling-maven-plugin

```xml
<build>
    <testSourceDirectory>src/main/scala</testSourceDirectory>
    <plugins>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-jar-plugin</artifactId>
            <version>${maven-jar-plugin.version}</version>
        </plugin>
        <plugin>
            <groupId>net.alchim31.maven</groupId>
            <artifactId>scala-maven-plugin</artifactId>
            <version>${scala-maven-plugin.version}</version>
            <executions>
                <execution>
                    <id>scala-compile-first</id>
                    <phase>process-resources</phase>
                    <goals>
                        <goal>add-source</goal>
                        <goal>compile</goal>
                    </goals>
                </execution>
                <execution>
                    <goals>
                        <goal>testCompile</goal>
                    </goals>
                    <configuration>
                        <jvmArgs>
                            <jvmArg>-Xss100M</jvmArg>
                        </jvmArgs>
                        <args>
                            <arg>-target:jvm-1.8</arg>
                            <arg>-deprecation</arg>
                            <arg>-feature</arg>
                            <arg>-unchecked</arg>
                            <arg>-language:implicitConversions</arg>
                            <arg>-language:postfixOps</arg>
                        </args>
                    </configuration>
                </execution>
            </executions>
        </plugin>
        <plugin>
            <groupId>io.gatling</groupId>
            <artifactId>gatling-maven-plugin</artifactId>
            <version>${gatling-maven-plugin.version}</version>
            <configuration>
                <configFolder>src/main/resources</configFolder>
                <resultsFolder>target/gatling/results</resultsFolder>
                <simulationsFolder>src/main/scala/simulation</simulationsFolder>
            </configuration>
        </plugin>
    </plugins>
</build>
```

ã•ã‚‰ã«ã€ä»Šå›ã¯mavenã‹ã‚‰å®Ÿè¡ŒãŒã§ãã‚‹ã ã‘ã§ãªãã€å®Ÿè¡Œå¯èƒ½ãªJarãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã—ãŸã„ã®ã§ã€

- maven-shade-plugin

ã‚‚è¿½åŠ ã—ãŸã€‚

Jarã«ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹éš›ã«å¤šãã®WarningãŒå‡ºã‚‹ãŸã‚ã€[ã“ã¡ã‚‰](https://kazuhira-r.hatenablog.com/entry/2020/11/23/001949)ã‚’å‚è€ƒã«ã•ã›ã¦é ‚ãã€é™¤å¤–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚‹ã€‚

```xml
<!-- çœç•¥ -->
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-shade-plugin</artifactId>
    <version>${maven-shade-plugin.version}</version>
    <executions>
        <execution>
            <phase>package</phase>
            <goals>
                <goal>shade</goal>
            </goals>
            <configuration>
                <transformers>
                    <transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
                        <mainClass>io.gatling.app.Gatling</mainClass>
                    </transformer>
                    <transformer implementation="org.apache.maven.plugins.shade.resource.ApacheLicenseResourceTransformer">
                    </transformer>
                    <transformer implementation="org.apache.maven.plugins.shade.resource.ApacheNoticeResourceTransformer">
                        <addHeader>false</addHeader>
                    </transformer>
                    <transformer implementation="org.apache.maven.plugins.shade.resource.properties.PropertiesTransformer">
                        <resource>META-INF/io.netty.versions.properties</resource>
                        <alreadyMergedKey>already_merged</alreadyMergedKey>
                    </transformer>
                </transformers>
                <filters>
                    <filter>
                        <artifact>*:*</artifact>
                        <excludes>
                            <exclude>LICENSE</exclude>
                            <exclude>NOTICE</exclude>
                            <exclude>module-info.class</exclude>
                            <exclude>META-INF/*.SF</exclude>
                            <exclude>META-INF/*.DSA</exclude>
                            <exclude>META-INF/*.RSA</exclude>
                            <exclude>META-INF/*.MF</exclude>
                            <exclude>META-INF/versions/*/module-info.class</exclude>
                        </excludes>
                    </filter>
                </filters>
            </configuration>
        </execution>
    </executions>
</plugin>
```


# Jarãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆæ–¹æ³•

mvnã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰packageã™ã‚‹ã ã‘

```bash
$ mvn package
[INFO] Scanning for projects...
[INFO]
[INFO] --------------------------< org.xxx:gatling >--------------------------
[INFO] Building gatling 1.0.0
[INFO] --------------------------------[ jar ]---------------------------------
[INFO]
[INFO] --- maven-resources-plugin:2.6:resources (default-resources) @ gatling ---
[INFO] Using 'UTF-8' encoding to copy filtered resources.
[INFO] Copying 3 resources
[INFO]
[INFO] --- scala-maven-plugin:4.5.3:add-source (scala-compile-first) @ gatling ---

~ä¸­ç•¥~

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  35.625 s
[INFO] Finished at: 2022-03-19T12:14:15+09:00
[INFO] ------------------------------------------------------------------------
```

# å®Ÿè¡Œæ–¹æ³•

## Mavenã‹ã‚‰å®Ÿè¡Œ

simulationClassã‚’æŒ‡å®šã™ã‚‹

```bash
$ mvn gatling:test -Dgatling.simulationClass=simulation.PeakModel
[INFO] Scanning for projects...
[INFO]
[INFO] --------------------------< org.xxx:gatling >--------------------------
[INFO] Building gatling 1.0.0
[INFO] --------------------------------[ jar ]---------------------------------
[INFO]
[INFO] --- gatling-maven-plugin:3.1.2:test (default-cli) @ gatling ---

~ä¸­ç•¥~

Simulation simulation.PeakModel started...

================================================================================
2022-03-19 12:11:57                                           5s elapsed
---- Requests ------------------------------------------------------------------
> Global                                                   (OK=0      KO=163   )
> group1 / TOP PAGE / TOP_post_pickup                      (OK=0      KO=97    )
> group2 / TOP PAGE / TOP_post_pickup                      (OK=0      KO=66    )
---- Errors --------------------------------------------------------------------
> jsonPath($.success).find.is(true) preparation crashed: Jackson    163 (100.0%)
 failed to parse into a valid AST: c.f.j.c.JsonParseException:...

---- ã‚·ãƒŠãƒªã‚ª1 ---------------------------------------------------------------------
          active: 0      / done: 97
---- ã‚·ãƒŠãƒªã‚ª2 ---------------------------------------------------------------------
          active: 1      / done: 66
================================================================================
```

## Jarãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å®Ÿè¡Œ

`-s`ã§ã‚¯ãƒ©ã‚¹åã‚’æŒ‡å®šã™ã‚‹

```bash
$ java -jar target/gatling-1.0.0.jar -s simulation.PeakModel
Simulation simulation.PeakModel started...

================================================================================
2022-03-19 12:15:37                                           5s elapsed
---- Requests ------------------------------------------------------------------
> Global                                                   (OK=0      KO=98    )
> group1 / TOP PAGE / TOP_post_pickup                      (OK=0      KO=39    )
> group2 / TOP PAGE / TOP_post_pickup                      (OK=0      KO=59    )
---- Errors --------------------------------------------------------------------
> jsonPath($.success).find.is(true) preparation crashed: Jackson     98 (100.0%)
 failed to parse into a valid AST: c.f.j.c.JsonParseException:...

---- ã‚·ãƒŠãƒªã‚ª1 ---------------------------------------------------------------------
          active: 1      / done: 39
---- ã‚·ãƒŠãƒªã‚ª2 ---------------------------------------------------------------------
          active: 1      / done: 59
================================================================================
```